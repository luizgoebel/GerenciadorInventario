@model GerenciadorInventario.WEB.ViewModels.MovimentoEstoqueVm
<div class="container-fluid">
    <form id="movForm">
        <div class="mb-3">
            <label class="form-label">Produto</label>
            <select name="ProdutoId" class="form-select" @(Model.LockProduct ? "disabled" : null)>
                <option value="">Selecione...</option>
                @foreach (var p in Model.Produtos)
                {
                    if (p.Id == Model.Movimento.ProdutoId)
                    {
                        <option value="@p.Id" selected>@p.Nome</option>
                    }
                    else
                    {
                        <option value="@p.Id">@p.Nome</option>
                    }
                }
            </select>
            @if(Model.LockProduct){<small class="text-muted">Produto bloqueado por seleção de linha.</small>}
        </div>
        <div class="mb-3">
            <label class="form-label">Quantidade</label>
            <input name="Quantidade" type="number" class="form-control" value="@Model.Movimento.Quantidade" />
        </div>
    </form>
</div>
<div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <button id="btnSalvarMov" class="btn btn-primary">Salvar</button>
</div>
<script>
    (function(){
        document.getElementById('btnSalvarMov').addEventListener('click', async function(){
            const form = document.getElementById('movForm');
            const data = Object.fromEntries(new FormData(form).entries());
            data.ProdutoId = parseInt(data.ProdutoId || '@Model.Movimento.ProdutoId');
            data.Quantidade = parseInt(data.Quantidade);
            const action = window.__movAction === 'entrada' ? '/Estoque/MovimentoEntrada' : '/Estoque/MovimentoSaida';
            const res = await Ui.postJson(action, data);
            if(res !== null){
                document.querySelector('#modalHost .modal.show .btn-close')?.click();
                window.EstoquePage.reloadTable();
            }
        });
    })();
</script>
