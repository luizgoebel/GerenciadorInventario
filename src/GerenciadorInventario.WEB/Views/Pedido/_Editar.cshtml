@model GerenciadorInventario.WEB.ViewModels.PedidoEditVm
<div class="container-fluid">
    <div class="alert alert-info">Criação de pedido simplificada. Inclua itens manualmente (ProdutoId, Quantidade, Preço).</div>
    <form id="pedidoForm">
        <div id="itensContainer"></div>
        <button class="btn btn-outline-primary btn-sm mt-2" type="button" id="btnAddItem"><i class="fa fa-plus"></i> Adicionar Item</button>
    </form>
</div>
<div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
    <button id="btnSalvarPedido" class="btn btn-primary">Salvar</button>
</div>
<script>
    (function(){
        const itens = [];
        const cont = document.getElementById('itensContainer');
        function render(){
            cont.innerHTML = itens.map((x,i)=>`
<div class="row g-2 align-items-end mb-2">
  <div class="col-4"><label class="form-label">Produto</label><input class="form-control" type="number" value="${x.produtoId||''}" data-i="${i}" data-f="produtoId" /></div>
  <div class="col-3"><label class="form-label">Quantidade</label><input class="form-control" type="number" value="${x.quantidade||1}" data-i="${i}" data-f="quantidade" /></div>
  <div class="col-3"><label class="form-label">Preço Unitário</label><input class="form-control" type="number" step="0.01" value="${x.precoUnitario||0}" data-i="${i}" data-f="precoUnitario" /></div>
  <div class="col-2 text-end"><button class="btn btn-outline-danger" type="button" data-rm="${i}"><i class="fa fa-trash"></i></button></div>
</div>`).join('');
            cont.querySelectorAll('input').forEach(inp=> inp.addEventListener('input', ()=>{
                const i = parseInt(inp.dataset.i);
                const f = inp.dataset.f;
                itens[i][f] = f==='precoUnitario'? parseFloat(inp.value||0) : parseInt(inp.value||0);
            }));
            cont.querySelectorAll('[data-rm]').forEach(btn=> btn.addEventListener('click', ()=>{ itens.splice(parseInt(btn.dataset.rm),1); render(); }));
        }
        document.getElementById('btnAddItem').addEventListener('click', ()=>{ itens.push({ produtoId:0, quantidade:1, precoUnitario:0 }); render(); });
        document.getElementById('btnSalvarPedido').addEventListener('click', async ()=>{
            const dto = { itens: itens.map(x=>({ produtoId:x.produtoId, quantidade:x.quantidade, precoUnitario:x.precoUnitario })) };
            const res = await Ui.postJson('/Pedido/Criar', dto);
            if(res){ document.querySelector('#modalHost .modal.show .btn-close')?.click(); window.PedidoPage.reloadTable(); }
        });
        render();
    })();
</script>
